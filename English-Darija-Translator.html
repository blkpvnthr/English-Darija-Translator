<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darija ↔ English Translator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .container {
            max-width: 600px;
        }
        .rtl {
            direction: rtl;
        }
        /* Custom styling for the primary text area */
        #inputText, #outputText {
            min-height: 150px;
            font-size: 1.125rem;
            transition: border-color 0.3s;
        }
        #inputText:focus, #outputText:focus {
            border-color: #3b82f6; /* Blue 500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-6 bg-gray-100">

    <div id="app" class="container w-full bg-white shadow-xl rounded-2xl p-6 sm:p-8 mt-4">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Darija Translator</h1>
        <p class="text-gray-600 mb-6">English ↔ Moroccan Arabic (Darija) via AI</p>

        <!-- Language Selector -->
        <div class="flex items-center justify-between mb-4 bg-gray-50 p-3 rounded-xl border border-gray-200">
            <span id="sourceLangDisplay" class="font-semibold text-lg text-gray-800">English</span>
            
            <button id="swapBtn" class="p-2 text-blue-600 hover:text-blue-800 transition duration-150 transform hover:rotate-180" onclick="swapLanguages()">
                <!-- Icon for swap -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m2.25-10.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                </svg>              
            </button>

            <span id="targetLangDisplay" class="font-semibold text-lg text-gray-800">Darija</span>
        </div>

        <!-- Input Text Area -->
        <textarea id="inputText" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition resize-none placeholder-gray-500" placeholder="Enter text to translate (e.g., How much does this cost?)" oninput="updateInputDirection()"></textarea>

        <!-- Translation Button -->
        <button id="translateBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 mt-4 disabled:opacity-50" onclick="translateText()">
            Translate
        </button>

        <!-- Output Display -->
        <div class="mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Translation Result</h2>
            <div id="outputContainer" class="bg-gray-50 p-4 border border-gray-300 rounded-xl">
                <p id="outputText" class="text-gray-900 text-lg whitespace-pre-wrap">The translation will appear here.</p>
                
                <!-- Status/Loading Indicator -->
                <div id="status" class="hidden text-sm text-gray-500 mt-2"></div>
            </div>
            
            <!-- Simulated Orthography/Notes Section (for MVP fulfillment) -->
            <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
                <p class="font-semibold">Linguistics Module Note (Simulated):</p>
                <p id="orthographyNote">This module ensures handling of Arabizi (romanization, e.g., '7' for 'ḥ') and contextual code-switching (French, Spanish, Amazigh loanwords).</p>
            </div>
        </div>

        <div class="mt-8 text-xs text-gray-500 border-t pt-4">
            <p><strong>MVP Implementation Notes:</strong></p>
            <ul class="list-disc list-inside space-y-1 mt-2 ml-4">
                <li><strong class="text-gray-700">API Backend:</strong> Powered by the Gemini 2.5 Flash API with search grounding for contextual accuracy.</li>
                <li><strong class="text-gray-700">Language Handling:</strong> Direction is automatically determined and swapped.</li>
                <li><strong class="text-gray-700">Data Simulation:</strong> The prompt uses a system instruction to simulate a finely tuned model trained on diverse Darija corpora.</li>
            </ul>
        </div>
    </div>

    <script type="module">
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        // --- Global Firebase Variables (Mandatory Canvas Environment Variables) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let auth, db; // Will hold initialized services

        // --- State Variables ---
        let sourceLang = 'English';
        let targetLang = 'Darija';
        let isAuthReady = false;

        // --- UI Element Selectors ---
        const inputText = document.getElementById('inputText');
        const outputText = document.getElementById('outputText');
        const sourceLangDisplay = document.getElementById('sourceLangDisplay');
        const targetLangDisplay = document.getElementById('targetLangDisplay');
        const translateBtn = document.getElementById('translateBtn');
        const statusDiv = document.getElementById('status');
        const orthographyNote = document.getElementById('orthographyNote');

        // Function to determine if text is primarily Arabic/Darija (for RTL alignment)
        function isDarija(text) {
            // Check for common Darija words (lbas, chno), Arabic letters, or Arabizi numbers
            const darijaMarkers = /[\u0600-\u06FF]|labas|chno|shkoun|safi|3|7|9/i;
            return darijaMarkers.test(text);
        }

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                isAuthReady = true;
                console.log("Firebase Auth initialized and user signed in.");
                // Set initial text direction
                updateInputDirection(); 

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                isAuthReady = true; // Still mark as ready to allow the app to run without auth features if possible
            }
        }
        
        // --- Core Application Functions ---

        window.swapLanguages = function() {
            [sourceLang, targetLang] = [targetLang, sourceLang];
            sourceLangDisplay.textContent = sourceLang;
            targetLangDisplay.textContent = targetLang;
            
            // Swap text direction on UI immediately
            updateInputDirection();
            
            // Clear output when swapping
            outputText.textContent = "The translation will appear here.";
        }

        window.updateInputDirection = function() {
            const currentText = inputText.value.trim();

            if (currentText.length === 0) {
                // If input is empty, default direction based on selected source language
                if (sourceLang === 'Darija') {
                    inputText.classList.add('rtl');
                    inputText.style.textAlign = 'right';
                    inputText.placeholder = 'أدخل النص للترجمة (مثلا: شحال الثمن ديال هادي؟)';
                } else {
                    inputText.classList.remove('rtl');
                    inputText.style.textAlign = 'left';
                    inputText.placeholder = 'Enter text to translate (e.g., How much does this cost?)';
                }
            } else {
                 // If text exists, determine direction based on content heuristics
                if (isDarija(currentText)) {
                    inputText.classList.add('rtl');
                    inputText.style.textAlign = 'right';
                } else {
                    inputText.classList.remove('rtl');
                    inputText.style.textAlign = 'left';
                }
            }
        }
        
        function setOutputDirection(text) {
            if (targetLang === 'Darija') {
                // Determine output direction based on the actual translation content (Darija is usually Arabic or Arabizi)
                if (isDarija(text)) {
                    outputContainer.classList.add('rtl');
                    outputText.style.textAlign = 'right';
                } else {
                     // For Romanized output, left align is often preferred
                    outputContainer.classList.remove('rtl');
                    outputText.style.textAlign = 'left';
                }
            } else {
                // English output is always LTR
                outputContainer.classList.remove('rtl');
                outputText.style.textAlign = 'left';
            }
        }

        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;
        const MAX_RETRIES = 5;

        async function fetchWithRetry(url, options, retries = 0) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 && retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                }
                return response;
            } catch (error) {
                if (retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                }
                throw error;
            }
        }

        window.translateText = async function() {
            const input = inputText.value.trim();
            if (!input) {
                alert("Please enter text to translate.");
                return;
            }

            // Set loading state
            translateBtn.disabled = true;
            translateBtn.textContent = 'Translating...';
            statusDiv.textContent = 'Contacting AI linguist...';
            statusDiv.classList.remove('hidden');
            outputText.textContent = ''; // Clear previous output

            const systemPrompt = `You are a world-class Moroccan Darija (Moroccan Arabic dialect) translator. 
                Your primary goal is to provide a translation that sounds natural and colloquial to a native Moroccan speaker, prioritizing Darija vernacular and common phrases over literal Modern Standard Arabic (MSA).
                Handle code-switching (French, Spanish, Amazigh loanwords) seamlessly.
                If the target language is Darija, provide the translation in both Arabic script and the common Romanized (Arabizi) form using numbers (3, 7, 9 etc.) for challenging sounds.
                If the target language is English, provide a clear, idiomatic English translation.
                Format your final output clearly with labels, e.g.:
                ---
                Darija (Arabic Script): [Translation]
                Darija (Arabizi): [Translation]
                ---
                or for English:
                ---
                English: [Translation]
                ---
                Do not include any other commentary, preamble, or explanation. Only output the formatted translation based on the user query.`;
            
            const userQuery = `Translate the following text from ${sourceLang} to ${targetLang}: "${input}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithRetry(API_URL, options);
                const result = await response.json();
                
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let text = candidate.content.parts[0].text.trim();
                    
                    // The model is instructed to format the output with markers. We display it cleanly.
                    if (targetLang === 'Darija') {
                         orthographyNote.innerHTML = 'The translation includes both standard Arabic script and Romanized (Arabizi) forms for practical use.';
                    } else {
                         orthographyNote.innerHTML = 'This translation successfully decoded the Darija input, handling non-standardized orthography and loanwords.';
                    }

                    // Remove the markers (--- and the labels) for cleaner display
                    text = text.replace(/---/g, '').trim();
                    text = text.replace(/Darija \(Arabic Script\): /g, '<span class="text-blue-700 font-medium">Arabic Script: </span>').trim();
                    text = text.replace(/Darija \(Arabizi\): /g, '\n<span class="text-blue-700 font-medium">Arabizi: </span>').trim();
                    text = text.replace(/English: /g, '<span class="text-blue-700 font-medium">English: </span>').trim();


                    outputText.innerHTML = text;
                    setOutputDirection(text);

                    // Handle grounding sources (simulating data collection/citation)
                    let sourcesHtml = '';
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        const sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                        
                        if (sources.length > 0) {
                            sourcesHtml = '<p class="text-gray-700 font-semibold mt-4">Simulated Citation Sources:</p><ul class="list-disc list-inside ml-4 mt-1 space-y-1">';
                            sources.forEach(source => {
                                sourcesHtml += `<li><a href="${source.uri}" target="_blank" class="text-blue-500 hover:underline">${source.title}</a></li>`;
                            });
                            sourcesHtml += '</ul>';
                        }
                    }
                    if (sourcesHtml) {
                         // Append sources to output container
                         outputContainer.innerHTML += sourcesHtml;
                    }

                } else {
                    outputText.textContent = "Translation failed: Could not parse response from AI model.";
                }

            } catch (error) {
                console.error("Translation API Call Failed:", error);
                outputText.textContent = `Error: The translation service is unavailable. Check the console for details.`;

            } finally {
                // Reset state
                translateBtn.disabled = false;
                translateBtn.textContent = 'Translate';
                statusDiv.classList.add('hidden');
            }
        }

        // Initialize on load
        window.onload = initializeFirebase;
    </script>
</body>
</html>

